{% extends 'attendance/base.html' %}

{% block content %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    $(document).ready(function () {
        get_users();
        get_attendances();
    });

    // ìˆœìœ„ ê³„ì‚°
    function get_rank(value, arr) {
        const sorted = arr.slice().sort(function (a, b) {
            return b - a
        });
        const rank = sorted.indexOf(value);
        if (rank > -1) return rank + 1;
        return null;
    }

    // ìœ ì € ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    function get_users() {
        $.ajax({
            method: "GET",
            url: "users/",
            dataType: "JSON",
            data: {}
        }).done(function (data) {
            let html = "";
            $.each(data, function(index, user) {
                let avatar_img_url = getAvatarImgUrl(user);
                html += `<a href="/attendance/users/${user}">`;
                html += `<img src="${avatar_img_url}" width="60" />`;
                html += `</a>`;
            });
            $("#users").html(html);
        });
    }

    // ì§„í–‰ë¥  ê·¸ë¦¬ê¸°
    function draw_progress(context) {
        let html = "";

        let progress_rate = Math.round(context.progressed_days / context.total_days * 100);

        html = `ì§„í–‰ë¥  ${progress_rate}%
         (ì´ ${context.total_days}ì¼ ì¤‘ ${context.progressed_days}ì¼ ì§„í–‰)
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated"
role="progressbar"
aria-valuenow="${progress_rate}" aria-valuemin="0"
aria-valuemax="100"
style="width: ${progress_rate}%"></div>
        </div>
`;
        $("#progress").html(html);
    }

    // ì¶œì„ë¥  ìˆœìœ„ ê·¸ë¦¬ê¸°
    function draw_rank(data) {
        data.sort(function (a, b) {
            return a.rank - b.rank;
        });

        let rank_html = `<table class="table table-sm table-rank">
<tbody>`;
        $.each(data, function (idx, item) {

            let avatar_img_url = getAvatarImgUrl(item.user);
            let num_per_line = 7;
            if (idx % num_per_line === 0)
                rank_html += `<tr>`;

            rank_html += `<td>${item.rank}ë“±<br>${Math.round(item.rate)}%</td>`;
            rank_html += `<td>
<a href="/attendance/users/${item.user}">
<img src="${avatar_img_url}" width="80" style="vertical-align:top"/>
</a>
${item.user}</td>`;

            if (idx % num_per_line === num_per_line - 1)
                rank_html += `</tr>`;
        });

        rank_html += `</tbody></table>`;

        $("#rank").html(rank_html);
    }

    // ì¶œì„/ë¯¸ì¶œì„ ê·¸ë¦¬ê¸°
    function draw_attend_noshow(context) {
        let total_attandance_rate = context.total_attend_count / (context.total_attend_count + context.total_noshow_count) * 100;
        let attend_noshow_html = "";
        attend_noshow_html += `${context.total_attend_count}/${context.total_noshow_count}<br>`;
        attend_noshow_html += `ì „ì²´ ì¶œì„ë¥ : ${Math.round(total_attandance_rate)}%`;

        $("#attend_noshow_div").html(attend_noshow_html);
    }

    // ì˜¤ëŠ˜ì˜ ì¶œì„ë¶€
    function draw_today_attendance(today_attendances) {
        let today_attendance_html = `<table class="table table-sm table-today-attendance"><tbody>`;

        let count_attendance = 0;
        let num_per_line = 10;
        $.each(today_attendances, function(idx, row) {
            if (idx % num_per_line === 0)
                today_attendance_html += `<tr>`;

            let formatted_datetime = "";
            if (row.attend !== null) {
                let avatar_img_url = getAvatarImgUrl(row.name);
                formatted_datetime = moment(row.attend).format("YYYY-MM-DD HH:mm:ss");
                count_attendance++;
                today_attendance_html += `<td>${row.name}<br>
<a href="/attendance/users/${row.name}">
<img src="${avatar_img_url}" width="60">
</a>
<br>ì¶œì„ì„±ê³µ!</td>`;
            } else {
                today_attendance_html += `<td>${row.name}<br>
<a href="/attendance/users/${row.name}">
<span class="no-show">ğŸ‹</span>
</a>
</td>`;
            }

            if (idx % num_per_line === num_per_line - 1)
                today_attendance_html += `</tr>`;

        });

        today_attendance_html += `</tbody></table>`;
        let rate = Math.round(count_attendance/today_attendances.length*100);
        today_attendance_html += `ì˜¤ëŠ˜ì˜ ì¶œì„ë¥ : ${rate}%`;

        $("#today_attendance").html(today_attendance_html);
    }

    // ì „ì²´ ì¶œì„ë¶€ ì¡°íšŒ
    function get_attendances() {
        $.ajax({
            method: "GET",
            url: "gets",
            dataType: "JSON",
            data: {}
        }).done(function (data) {
            // data = [{user: user, attendances: }, ...]
            // rate, count ëŠ” ë°ì´í„° ê°€ê³µí•˜ë©´ì„œ ì¶”ê°€í•¨

            // ì„¤ì •, í†µê³„ì •ë³´ ë“±ë“± ì—¬ëŸ¬ ì •ë³´ ìŒ“ì•„ë‘ëŠ” ê³³
            let context = {
                total_attend_count: 0, // ì „ì²´ ì¶œì„ ì¹´ìš´íŠ¸
                total_noshow_count: 0, // ì „ì²´ ë¯¸ì¶œì„ ì¹´ìš´íŠ¸
                start_day: new Date(2019, 10-1, 1), // ì‹œì‘ì¼ 2019.10.01
                today: new Date(), // ì˜¤ëŠ˜
                formatted_today: moment().format("YYYY-MM-DD"),
                yesterday: new Date(new Date().setDate(new Date().getDate()-1)), // ì–´ì œ
                formatted_dates: [], // ì‹œì‘ì¼~ì–´ì œ ê¹Œì§€ YYYY-MM-DD ë¦¬ìŠ¤íŠ¸
                total_days: 100, // 100ì¼ê°„ ì§„í–‰í•¨
                progressed_days: 0, // ì§„í–‰ ì¼ìˆ˜
            };

            // ì¶œì„ë¶€ ë‚ ì§œ ë²”ìœ„ 2019.10.01 ~ ì–´ì œ
            for (let d = context.start_day; d <= context.yesterday; d.setDate(d.getDate() + 1)) {
                context.formatted_dates.push(moment(d).format("YYYY-MM-DD"));
            }

            // ì§„í–‰ ì¼ìˆ˜
            context.progressed_days = context.formatted_dates.length;

            // data ì— rate, count ì¶”ê°€
            let counts_by_user = [];
            let daily_count = {};
            let today_attendances = []; // ì˜¤ëŠ˜ ì¶œì„ ë°ì´í„°

            $.each(data, function(index, data_row) {
                let count_by_user = 0;
                $.each(context.formatted_dates, function (idx, formatted_date) {
                    if (formatted_date in data_row.attendances) {
                        count_by_user++;
                        if (!(formatted_date in daily_count)) {
                            daily_count[formatted_date] = 0;
                        }
                        daily_count[formatted_date]++;
                        context.total_attend_count++;
                    } else {
                        context.total_noshow_count++;
                    }
                });

                counts_by_user.push(count_by_user);

                // data ì— rate, count ì •ë³´ ì¶”ê°€
                data_row["rate"] = (count_by_user / context.formatted_dates.length) * 100;
                data_row["count"] = count_by_user;

                // ì˜¤ëŠ˜ ì¶œì„ ë°ì´í„°
                let today_attendance = {name: data_row.user, attend: null};
                if (context.formatted_today in data_row.attendances) {
                    today_attendance.attend = data_row.attendances[context.formatted_today];
                }
                today_attendances.push(today_attendance)
            });

            // data ì— rank ì¶”ê°€
            $.each(data, function(index, data_row) {
                data_row["rank"] = get_rank(data_row.count, counts_by_user);
            });

            // table ê·¸ë¦¬ê¸°
            let html = `<table id="attendance-table" class="table table-sm table-striped attendance-table">
<thead>
<tr>
<th>No</th>
<th>user</th>
<th>ì¶œì„ë¥ </th>
<th>ìˆœìœ„</th>
`;
            // ë‚ ì§œ í—¤ë”
            $.each(context.formatted_dates, function(idx, formatted_date) {
                html += `<th class="attendance_date">${formatted_date}</th>`;
            });
            html += `</tr></thead>
<tbody>
`;

            $.each(data, function(index, data_row) {
                let attendances_cell_html = "";
                $.each(context.formatted_dates, function (idx, formatted_date) {
                    if (formatted_date in data_row.attendances) {
                        attendances_cell_html += `<td title="${data_row.attendances[formatted_date]}">O</td>`;
                    } else {
                        attendances_cell_html += `<td>X</td>`;
                    }
                });

                html += `<tr data-count="${data_row.count}" data-user="${data_row.user}" class="user">`;
                html += `<td>${index + 1}</td>`;
                html += `<td>
<a href="/attendance/users/${data_row.user}" target="_blank">
${data_row.user}
</a></td>`;
                html += `<td>${Math.round(data_row.rate)}%</td>`;
                html += `<td class="rank">${data_row.rank}</td>`;
                html += attendances_cell_html;
                html += `</tr>`;
            });

            // ë‚ ì§œë³„ ì¶œì„ë¥ 
            let daily_rate = [];
            let daily_rate_html = `<td></td>
<td></td>
<td></td>`; // ë¹ˆì¹¸ë“¤

            daily_rate_html += "<td>ì¶œì„ë¥ </td>";
            $.each(context.formatted_dates, function(idx, formatted_date) {
                let rate = (daily_count[formatted_date] / data.length) * 100;
                daily_rate_html += `<td>${Math.round(rate)}%</td>`;

                daily_rate.push([formatted_date, rate, rate.toString() + "%"]);
            });

            html += `<tr>${daily_rate_html}</tr>`;
            html += "</tbody></table>";
            $("#attendance").html(html);

            // ìˆœìœ„ë³„ í‘œì‹œ
            draw_rank(data);

            // ì§„í–‰ë¥ 
            draw_progress(context);

            // ì¶œì„/ë¯¸ì¶œì„ ì¹´ìš´íŠ¸
            draw_attend_noshow(context);


            // ì¶œì„ë¥  ê·¸ë˜í”„
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            function drawChart() {
                const chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'Dates');
                chartData.addColumn('number', 'ì¶œì„ë¥ ');
                chartData.addColumn({type:'string', role:'annotation'});
                chartData.addRows(daily_rate);

                const options = {
                    title: 'ì •ì›ì‚¬ë“¤ ì¶œì„ë¥ ',
                    hAxis: {title: 'Dates'},
                    vAxis: {title: 'ì¶œì„ë¥ ', maxValue: 100, minValue: 0},
                    legend: 'none',
                    width: "100%",
                    height: 400,
                    displayAnnotations: true,
                    trendlines: {1: {}}    // Draw a trendline for data series 0.
                };

                const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
                chart.draw(chartData, options);
            }

            // ì˜¤ëŠ˜ ì¶œì„ í˜„í™©
            draw_today_attendance(today_attendances);
        }).fail(function (data) {
            console.log(data);
            alert("ì¶œì„ë¶€ ì‹¤íŒ¨");
        });
    }

</script>
<div class="container">
    <h2 id="users_title">ì •ì›ì‚¬ë“¤</h2>
    <div id="users"></div>
    <br>
    <h2 id="progress_title">ì •ì›ì‚¬ë“¤ ì‹œì¦Œ4 ì§„í–‰ë¥ </h2>
    <div id="progress"></div>
    <br>
    <h2 id="attend_noshow_title">ì¶œì„/ë¯¸ì¶œì„</h2>
    <div id="attend_noshow_div"></div>
    <br>
    <h2 id="today_attendance_title">ì˜¤ëŠ˜ì˜ ì¶œì„ë¶€</h2>1ì‹œê°„ ë§ˆë‹¤ ê°±ì‹  ë©ë‹ˆë‹¤.
    <div id="today_attendance"></div>
    <br>
</div>
<div class="container-fluid">
    <h2 id="attendance_title">ì¶œì„ë¶€</h2>
    <div id="attendance"></div>
    <br>
</div>
<div class="container">
    <h2 id="rank_title">ì¶œì„ë¥  ìˆœìœ„</h2>
    <div id="rank"></div>

    <h2 id="chart_title">ì¶œì„ë¥  ê·¸ë˜í”„</h2>
    <div id="chart_div"></div>

</div>

{% endblock %}